<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="./style.css"/>
	</head>
	<body>
		<img src="./film movie recs.jpg" style="width: 100%"/>
		<div id="movie" class="movie"></div>
	</body>
</html>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/babel">
	class InputMovie extends React.Component {
		constructor (props) {
			super(props)
			window.scrollTo(0, 0)
			this.searchMovies = this.searchMovies.bind(this)
			this.movieSelection = this.movieSelection.bind(this)
            this.loading = true
			this.movies = []
			this.options = []
			this.movieInput = ''
			this.recommendations = 'Enter a movie title and click it\nGet 10 recommended similar movies'
			this.api = 'https://5ebsomi6g8.execute-api.us-east-1.amazonaws.com/prd'
			this.query = new URLSearchParams(window.location.search).get('admin');
		}

		componentDidMount () {
			this.getMovies()
		}

		async getMovies (remove=false) {
			this.loading = true
			this.forceUpdate()
			if (localStorage.getItem('movies') !== null && !remove) {
				console.log('Getting movies from cache')
				this.movies = JSON.parse(localStorage.getItem('movies'));
			} else {
				console.log('Getting movies from api')
				let response = await axios.get(`${this.api}/movies`) // get all titles containing movieInput query
				this.movies = JSON.parse(response.data.body)
				localStorage.setItem('movies', response.data.body)
			}
			this.loading = false
			this.forceUpdate()
		}

		searchMovies (event) {
			this.movieInput = event.target.value // get the input value
			if (this.movieInput.trim()) { // remove trailing whitespaces, only do if not empty
				// clean up and encode movieInput before API request
				let movieInput = `${this.clean(this.movieInput)}`
				let filtered = this.movies.filter(movie => { // set options to display
					let simpleTitle = this.clean(movie.titleYear.slice(0, -7))
					return simpleTitle.includes(movieInput)
				})
				this.options = filtered.sort((a, b) => {
					let simpleTitleA = this.clean(a.titleYear.slice(0, -7))
					let simpleTitleB = this.clean(b.titleYear.slice(0, -7))
					if (simpleTitleA == movieInput && simpleTitleB == movieInput) {
						return 0
					} else if (simpleTitleA == movieInput) {
						return -1
					} else if (simpleTitleB == movieInput) {
						return 1
					}
					let aIndex = simpleTitleA.indexOf(movieInput);
					let bIndex = simpleTitleB.indexOf(movieInput);
					if (aIndex < bIndex) {
						return -1
					} else if (aIndex > bIndex) {
						return 1
					} else {
						return 0
					}
				})
			} else { // if empty after removing trailing whitespaces
				this.movieInput = '' // make sure the input value is set to be empty
				this.options = [] // and options are empty
			}
			this.forceUpdate()
		}

		clean (movie) {
			return movie.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-\'\"_`~()]/g,'')
		}

		async movieSelection (ind) {
			event.preventDefault();
            this.loading = true
			this.forceUpdate()
			let response = await axios.get(`${this.api}/predict?ind=${ind}`)
			this.recommendations = JSON.parse(response.data.body)['prediction_text']
			this.movieInput = ''
			this.options = []
            this.loading = false
			this.forceUpdate()
		}

		render () {
			if (this.loading) {
				// loading screen
                return (
					<div className="loading1">
						<div className="loading2">LOADING</div>
					</div>
				)
			} else if (this.query) {
				// admin get all movie data button screen (just go to /?admin=1 . could be = anything, just needs to exist)
				return (
					<button onClick={() => this.getMovies(true)}>
						Click to get all movie data
					</button>
				)
			} else if (this.movieInput && this.options && this.options.length > 0) {
				// movie options buttons display
				return (
					<div className="outer-div">
						<input className="input" align="middle" id="inp"
							type="text" 
							value={this.movieInput}
							onChange={this.searchMovies}
							placeholder="TYPE TITLE HERE"
							onKeyPress={(e) => { e.key === 'Enter' && e.preventDefault(); }}
						/>
						<div className="options">
							{this.options.map((dict) => <button onClick={() => this.movieSelection(dict['ind'])} key={`${dict['titleYear']}-${dict['ind']}`}>{dict['titleYear']}</button>)}
						</div>
					</div>
				)
			} else {
				// home screen / results screen
				return (
					<div className="outer-div">
						<input className="input" align="middle" id="inp"
							type="text" 
							value={this.movieInput}
							onChange={this.searchMovies}
							placeholder="TYPE TITLE HERE"
							autoFocus
						/>
						<div className="results">
							{
								this.recommendations.split('\n\n').map((value, index) =>
									<div className="result" key={`${value}-${index}`}>
										<div className = "line1">
											{value.split('\n')[0]}
										</div>
										<div className = "line2">
											{value.split('\n')[1]}
										</div>
										<div className = "line3">
											{value.split('\n')[2]}
										</div>
									</div>
								)
							}
						</div>
					</div>
				)
			}
		}
	}
	const root = ReactDOM.createRoot(document.getElementById('movie'));
	root.render(<InputMovie />);
</script>