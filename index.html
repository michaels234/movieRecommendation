<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="./style.css"/>
	</head>
	<body>
		<div id="movie" class="movie"/>
	</body>
</html>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script type="text/babel">
	class InputMovie extends React.Component {
		constructor (props) {
			super(props)
			window.scrollTo(0, 0)
			this.searchMovies = this.searchMovies.bind(this)
			this.movieSelection = this.movieSelection.bind(this)
            this.loading = true
			this.options = []
			this.movieInput = ''
			this.recommendations = 'Enter a movie title\nand get 10 recommended similar movies'
		}

		componentDidMount () {
            this.loading = false
			this.forceUpdate()
		}

		async searchMovies (event) {
			this.movieInput = event.target.value // get the input value
			if (this.movieInput.trim()) { // remove trailing whitespaces, only do if not empty
				// clean up and encode movieInput before API request
				let movieInput = encodeURIComponent(`"${this.movieInput.trim().toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-\'\"_`~()]/g,'')}"`)
				let response = await axios.get(`/movies?title=${movieInput}`) // get all titles containing movieInput query
				this.options = response.data // set options to display
			} else { // if empty after removing trailing whitespaces
				this.movieInput = '' // make sure the input value is set to be empty
				this.options = [] // and options are empty
			}
			this.forceUpdate()
		}

		async movieSelection (ind) {
			event.preventDefault();
            this.loading = true
			this.forceUpdate()
			let response = await axios.get(`/predict?ind=${ind}`)
			this.recommendations = response.data['prediction_text']
			this.movieInput = ''
			this.options = []
            this.loading = false
			this.forceUpdate()
		}

		render () {
			if (this.movieInput && this.options && this.options.length > 0 && !this.loading) {
				return (
					<div className="outer-div">
						<input className="input" align="middle" id="inp"
							type="text" 
							value={this.movieInput}
							onChange={this.searchMovies}
							placeholder="TYPE TITLE HERE"
							onKeyPress={(e) => { e.key === 'Enter' && e.preventDefault(); }}
						/>
						<div className="options">
							{this.options.map((dict) => <button onClick={() => this.movieSelection(dict['ind'])} key={dict['ind']}>{dict['titleYear']}</button>)}
						</div>
					</div>
				)
			} else if (!this.loading) {
				return (
					<div className="outer-div">
						<input className="input" align="middle" id="inp"
							type="text" 
							value={this.movieInput}
							onChange={this.searchMovies}
							placeholder="TYPE TITLE HERE"
							autoFocus
						/>
						<div className="results">
							{
								this.recommendations.split('\n\n').map((value, index) =>
									<div className="result" key={value + index}>
										<div className = "line1">
											{value.split('\n')[0]}
										</div>
										<div className = "line2">
											{value.split('\n')[1]}
										</div>
										<div className = "line3">
											{value.split('\n')[2]}
										</div>
									</div>
								)
							}
						</div>
					</div>
				)
			} else {
                return (
					<div className="loading1">
						<div className="loading2">LOADING</div>
					</div>
				)
            }
		}
	}
	const root = ReactDOM.createRoot(document.getElementById('movie'));
	root.render(<InputMovie />);
</script>